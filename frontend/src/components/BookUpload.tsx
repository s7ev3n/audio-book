import React, { useCallback, useState } from 'react';\nimport {\n  Container,\n  Paper,\n  Typography,\n  Box,\n  Button,\n  CircularProgress,\n  Alert,\n  LinearProgress\n} from '@mui/material';\nimport { Upload, CloudUpload } from '@mui/icons-material';\nimport { useDropzone } from 'react-dropzone';\nimport { useMutation } from 'react-query';\nimport { useNavigate } from 'react-router-dom';\n\nimport { epubAPI } from '../services/api';\nimport { useBookStore } from '../store/bookStore';\n\nconst BookUpload: React.FC = () => {\n  const navigate = useNavigate();\n  const { setCurrentBook, setChapters } = useBookStore();\n  const [uploadProgress, setUploadProgress] = useState(0);\n\n  const uploadMutation = useMutation(epubAPI.uploadEpub, {\n    onSuccess: (bookInfo) => {\n      setCurrentBook(bookInfo);\n      setChapters(bookInfo.chapters);\n      navigate(`/reader/${bookInfo.id}`);\n    },\n    onError: (error: any) => {\n      console.error('Upload failed:', error);\n    }\n  });\n\n  const onDrop = useCallback((acceptedFiles: File[]) => {\n    const file = acceptedFiles[0];\n    if (file) {\n      uploadMutation.mutate(file);\n    }\n  }, [uploadMutation]);\n\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\n    onDrop,\n    accept: {\n      'application/epub+zip': ['.epub']\n    },\n    maxFiles: 1,\n    multiple: false\n  });\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      uploadMutation.mutate(file);\n    }\n  };\n\n  return (\n    <Container maxWidth=\"md\" sx={{ mt: 4 }}>\n      <Paper elevation={3} sx={{ p: 4 }}>\n        <Typography variant=\"h4\" component=\"h1\" gutterBottom align=\"center\">\n          ğŸ“– ä¸Šä¼  EPUB ç”µå­ä¹¦\n        </Typography>\n        \n        <Typography variant=\"body1\" color=\"text.secondary\" align=\"center\" sx={{ mb: 4 }}>\n          æ”¯æŒå°†è‹±æ–‡EPUBç”µå­ä¹¦ç¿»è¯‘æˆä¸­æ–‡æœ‰å£°ä¹¦\n        </Typography>\n\n        {uploadMutation.isError && (\n          <Alert severity=\"error\" sx={{ mb: 2 }}>\n            ä¸Šä¼ å¤±è´¥ï¼š{uploadMutation.error instanceof Error ? \n              uploadMutation.error.message : 'æœªçŸ¥é”™è¯¯'}\n          </Alert>\n        )}\n\n        {uploadMutation.isLoading ? (\n          <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', py: 4 }}>\n            <CircularProgress size={60} sx={{ mb: 2 }} />\n            <Typography variant=\"h6\" gutterBottom>\n              æ­£åœ¨å¤„ç†EPUBæ–‡ä»¶...\n            </Typography>\n            <Typography variant=\"body2\" color=\"text.secondary\">\n              è¯·ç¨å€™ï¼Œæ­£åœ¨è§£æç« èŠ‚å†…å®¹\n            </Typography>\n            {uploadProgress > 0 && (\n              <Box sx={{ width: '100%', mt: 2 }}>\n                <LinearProgress variant=\"determinate\" value={uploadProgress} />\n              </Box>\n            )}\n          </Box>\n        ) : (\n          <>\n            <Box\n              {...getRootProps()}\n              sx={{\n                border: '2px dashed',\n                borderColor: isDragActive ? 'primary.main' : 'grey.300',\n                borderRadius: 2,\n                p: 4,\n                textAlign: 'center',\n                cursor: 'pointer',\n                bgcolor: isDragActive ? 'action.hover' : 'transparent',\n                transition: 'all 0.2s ease-in-out',\n                '&:hover': {\n                  bgcolor: 'action.hover',\n                  borderColor: 'primary.main'\n                }\n              }}\n            >\n              <input {...getInputProps()} />\n              <CloudUpload sx={{ fontSize: 64, color: 'grey.400', mb: 2 }} />\n              <Typography variant=\"h6\" gutterBottom>\n                {isDragActive \n                  ? 'æ”¾ä¸‹æ–‡ä»¶ä»¥å¼€å§‹ä¸Šä¼ ' \n                  : 'æ‹–æ‹½EPUBæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶'\n                }\n              </Typography>\n              <Typography variant=\"body2\" color=\"text.secondary\">\n                ä»…æ”¯æŒ .epub æ ¼å¼çš„ç”µå­ä¹¦æ–‡ä»¶\n              </Typography>\n            </Box>\n\n            <Box sx={{ display: 'flex', justifyContent: 'center', mt: 3 }}>\n              <Button\n                variant=\"contained\"\n                component=\"label\"\n                startIcon={<Upload />}\n                size=\"large\"\n              >\n                é€‰æ‹©EPUBæ–‡ä»¶\n                <input\n                  type=\"file\"\n                  accept=\".epub\"\n                  hidden\n                  onChange={handleFileSelect}\n                />\n              </Button>\n            </Box>\n          </>\n        )}\n\n        <Box sx={{ mt: 4, p: 2, bgcolor: 'grey.50', borderRadius: 1 }}>\n          <Typography variant=\"h6\" gutterBottom>\n            ğŸ“‹ åŠŸèƒ½è¯´æ˜\n          </Typography>\n          <Typography variant=\"body2\" component=\"div\">\n            <ul style={{ margin: 0, paddingLeft: '1.5em' }}>\n              <li>ä¸Šä¼ è‹±æ–‡EPUBç”µå­ä¹¦æ–‡ä»¶</li>\n              <li>è‡ªåŠ¨è§£æç« èŠ‚ç»“æ„å’Œå†…å®¹</li>\n              <li>ä½¿ç”¨AIå¤§æ¨¡å‹ç¿»è¯‘æˆä¸­æ–‡</li>\n              <li>ç”Ÿæˆä¸­æ–‡è¯­éŸ³æœ—è¯»</li>\n              <li>åŒæ æ˜¾ç¤ºåŸæ–‡å’Œè¯‘æ–‡</li>\n              <li>æ”¯æŒéŸ³é¢‘æ’­æ”¾å’Œæ–‡å­—åŒæ­¥</li>\n            </ul>\n          </Typography>\n        </Box>\n      </Paper>\n    </Container>\n  );\n};\n\nexport default BookUpload;