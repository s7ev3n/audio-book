import React, { useState, useEffect } from 'react';\nimport {\n  Box,\n  Grid,\n  Paper,\n  Typography,\n  Button,\n  CircularProgress,\n  Alert,\n  Divider,\n  IconButton,\n  Tooltip\n} from '@mui/material';\nimport {\n  Translate,\n  VolumeUp,\n  Refresh,\n  PlayArrow\n} from '@mui/icons-material';\nimport { useQuery, useMutation } from 'react-query';\n\nimport { ChapterInfo } from '../types/book';\nimport { epubAPI, translationAPI, ttsAPI } from '../services/api';\nimport { useBookStore } from '../store/bookStore';\n\ninterface TextDisplayProps {\n  bookId: string;\n  chapter: ChapterInfo;\n}\n\nconst TextDisplay: React.FC<TextDisplayProps> = ({ bookId, chapter }) => {\n  const {\n    originalText,\n    translatedText,\n    isTranslating,\n    isGeneratingAudio,\n    setOriginalText,\n    setTranslatedText,\n    setTranslating,\n    setGeneratingAudio,\n    setAudioUrl\n  } = useBookStore();\n\n  const [translationTaskId, setTranslationTaskId] = useState<string | null>(null);\n  const [audioTaskId, setAudioTaskId] = useState<string | null>(null);\n  const [highlightedText, setHighlightedText] = useState<string>('');\n\n  // è·å–åŸæ–‡å†…å®¹\n  const { data: chapterContent, isLoading } = useQuery(\n    ['chapterContent', bookId, chapter.id],\n    () => epubAPI.getChapterContent(bookId, chapter.id),\n    {\n      onSuccess: (content) => {\n        setOriginalText(content);\n      }\n    }\n  );\n\n  // ç¿»è¯‘ç« èŠ‚\n  const translateMutation = useMutation(\n    () => translationAPI.translateChapter(bookId, chapter.id),\n    {\n      onSuccess: (taskId) => {\n        setTranslationTaskId(taskId);\n        setTranslating(true);\n      },\n      onError: (error) => {\n        console.error('Translation failed:', error);\n        setTranslating(false);\n      }\n    }\n  );\n\n  // ç”ŸæˆéŸ³é¢‘\n  const generateAudioMutation = useMutation(\n    (translationId: string) => \n      ttsAPI.generateChapterAudio(bookId, chapter.id, translationId),\n    {\n      onSuccess: (taskId) => {\n        setAudioTaskId(taskId);\n        setGeneratingAudio(true);\n      },\n      onError: (error) => {\n        console.error('Audio generation failed:', error);\n        setGeneratingAudio(false);\n      }\n    }\n  );\n\n  // è½®è¯¢ç¿»è¯‘çŠ¶æ€\n  useQuery(\n    ['translationStatus', translationTaskId],\n    () => translationAPI.getTranslationStatus(translationTaskId!),\n    {\n      enabled: !!translationTaskId && isTranslating,\n      refetchInterval: 2000,\n      onSuccess: (status) => {\n        if (status.status === 'completed') {\n          // è¿™é‡Œåº”è¯¥è·å–ç¿»è¯‘ç»“æœï¼Œç®€åŒ–å¤„ç†\n          setTranslatedText('ç¿»è¯‘å·²å®Œæˆï¼Œè¯·åˆ·æ–°æŸ¥çœ‹ç»“æœ'); // å®é™…åº”è¯¥è°ƒç”¨APIè·å–ç»“æœ\n          setTranslating(false);\n          setTranslationTaskId(null);\n        } else if (status.status === 'failed') {\n          setTranslating(false);\n          setTranslationTaskId(null);\n        }\n      }\n    }\n  );\n\n  // è½®è¯¢éŸ³é¢‘ç”ŸæˆçŠ¶æ€\n  useQuery(\n    ['audioStatus', audioTaskId],\n    () => ttsAPI.getAudioStatus(audioTaskId!),\n    {\n      enabled: !!audioTaskId && isGeneratingAudio,\n      refetchInterval: 3000,\n      onSuccess: (status) => {\n        if (status.status === 'completed' && status.audio_url) {\n          setAudioUrl(status.audio_url);\n          setGeneratingAudio(false);\n          setAudioTaskId(null);\n        } else if (status.status === 'failed') {\n          setGeneratingAudio(false);\n          setAudioTaskId(null);\n        }\n      }\n    }\n  );\n\n  const handleTranslate = () => {\n    if (!isTranslating) {\n      translateMutation.mutate();\n    }\n  };\n\n  const handleGenerateAudio = () => {\n    if (translationTaskId && !isGeneratingAudio) {\n      generateAudioMutation.mutate(translationTaskId);\n    }\n  };\n\n  const highlightTextSegment = (text: string, highlight: string) => {\n    if (!highlight) return text;\n    \n    const parts = text.split(new RegExp(`(${highlight})`, 'gi'));\n    return parts.map((part, index) => \n      part.toLowerCase() === highlight.toLowerCase() ? (\n        <span key={index} style={{ \n          backgroundColor: '#ffeb3b', \n          padding: '2px 4px',\n          borderRadius: '4px' \n        }}>\n          {part}\n        </span>\n      ) : part\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100%' }}>\n        <CircularProgress />\n      </Box>\n    );\n  }\n\n  return (\n    <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column', p: 2 }}>\n      {/* ç« èŠ‚æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® */}\n      <Paper elevation={1} sx={{ p: 2, mb: 2 }}>\n        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>\n          <Typography variant=\"h6\" component=\"h2\">\n            {chapter.title}\n          </Typography>\n          \n          <Box sx={{ display: 'flex', gap: 1 }}>\n            <Tooltip title=\"ç¿»è¯‘ç« èŠ‚\">\n              <Button\n                variant=\"outlined\"\n                startIcon={isTranslating ? <CircularProgress size={16} /> : <Translate />}\n                onClick={handleTranslate}\n                disabled={isTranslating}\n                size=\"small\"\n              >\n                {isTranslating ? 'ç¿»è¯‘ä¸­...' : 'ç¿»è¯‘'}\n              </Button>\n            </Tooltip>\n            \n            <Tooltip title=\"ç”Ÿæˆè¯­éŸ³\">\n              <Button\n                variant=\"outlined\"\n                startIcon={isGeneratingAudio ? <CircularProgress size={16} /> : <VolumeUp />}\n                onClick={handleGenerateAudio}\n                disabled={!translatedText || isGeneratingAudio}\n                size=\"small\"\n              >\n                {isGeneratingAudio ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè¯­éŸ³'}\n              </Button>\n            </Tooltip>\n          </Box>\n        </Box>\n        \n        {translateMutation.isError && (\n          <Alert severity=\"error\" sx={{ mb: 1 }}>\n            ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•\n          </Alert>\n        )}\n        \n        {generateAudioMutation.isError && (\n          <Alert severity=\"error\" sx={{ mb: 1 }}>\n            éŸ³é¢‘ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•\n          </Alert>\n        )}\n      </Paper>\n\n      {/* åŒæ æ–‡æœ¬æ˜¾ç¤º */}\n      <Box sx={{ flexGrow: 1, overflow: 'hidden' }}>\n        <Grid container spacing={2} sx={{ height: '100%' }}>\n          {/* åŸæ–‡æ  */}\n          <Grid item xs={12} md={6} sx={{ height: '100%' }}>\n            <Paper \n              elevation={2} \n              sx={{ \n                height: '100%', \n                display: 'flex', \n                flexDirection: 'column',\n                overflow: 'hidden'\n              }}\n            >\n              <Box sx={{ p: 2, bgcolor: 'primary.main', color: 'primary.contrastText' }}>\n                <Typography variant=\"subtitle1\" fontWeight=\"bold\">\n                  ğŸ‡ºğŸ‡¸ åŸæ–‡ (English)\n                </Typography>\n              </Box>\n              \n              <Box sx={{ \n                flexGrow: 1, \n                p: 2, \n                overflow: 'auto',\n                fontSize: '0.95rem',\n                lineHeight: 1.6\n              }}>\n                <Typography \n                  variant=\"body1\" \n                  component=\"div\"\n                  sx={{ whiteSpace: 'pre-wrap' }}\n                >\n                  {highlightTextSegment(originalText, highlightedText)}\n                </Typography>\n              </Box>\n            </Paper>\n          </Grid>\n\n          {/* è¯‘æ–‡æ  */}\n          <Grid item xs={12} md={6} sx={{ height: '100%' }}>\n            <Paper \n              elevation={2} \n              sx={{ \n                height: '100%', \n                display: 'flex', \n                flexDirection: 'column',\n                overflow: 'hidden'\n              }}\n            >\n              <Box sx={{ p: 2, bgcolor: 'secondary.main', color: 'secondary.contrastText' }}>\n                <Typography variant=\"subtitle1\" fontWeight=\"bold\">\n                  ğŸ‡¨ğŸ‡³ è¯‘æ–‡ (ä¸­æ–‡)\n                </Typography>\n              </Box>\n              \n              <Box sx={{ \n                flexGrow: 1, \n                p: 2, \n                overflow: 'auto',\n                fontSize: '1rem',\n                lineHeight: 1.8\n              }}>\n                {translatedText ? (\n                  <Typography \n                    variant=\"body1\" \n                    component=\"div\"\n                    sx={{ whiteSpace: 'pre-wrap' }}\n                  >\n                    {highlightTextSegment(translatedText, highlightedText)}\n                  </Typography>\n                ) : (\n                  <Box sx={{ \n                    display: 'flex', \n                    flexDirection: 'column',\n                    alignItems: 'center', \n                    justifyContent: 'center',\n                    height: '100%',\n                    color: 'text.secondary'\n                  }}>\n                    <Translate sx={{ fontSize: 48, mb: 2, opacity: 0.5 }} />\n                    <Typography variant=\"body1\" align=\"center\">\n                      ç‚¹å‡»ä¸Šæ–¹\"ç¿»è¯‘\"æŒ‰é’®å¼€å§‹ç¿»è¯‘ç« èŠ‚\n                    </Typography>\n                  </Box>\n                )}\n              </Box>\n            </Paper>\n          </Grid>\n        </Grid>\n      </Box>\n    </Box>\n  );\n};\n\nexport default TextDisplay;